#lang racket/base

;; This module defines the bessel functions of integer order
(require racket/contract/base)
(provide
 (contract-out
  [bessj₀ (-> number? number?)]
  [bessj₁ (-> number? number?)]
  [bessj  (-> integer? number? number?)]
  [bessy₀ (-> number? number?)]
  [bessy₁ (-> number? number?)]
  [bessy  (-> integer? number? number?)]
  [bessh₀ (-> number? complex?)]
  [bessh₁ (-> number? complex?)]
  [bessh  (-> integer? number? complex?)]))

(require
 (only-in mechanics
          π
          π/4
          π/2
          3π/4
          2/π))

(require
 (only-in racket/fixnum
          fx+
          fx=
          fx<
          fx-))
(require
 (only-in math/number-theory factorial))

;; Utilities for special functions

(define (round-to-even x)
  (let ([xn (inexact->exact (round x))])
    (if (odd? xn) (fx+ xn 1) xn)))

;; computes ∑ cᵢ xⁱ
(define (poly-by-coeffs->value x . coeffs)
  (let lp ([coeffs coeffs])
    (if (null? (cdr coeffs))
        (car coeffs)
        (+ (car coeffs)
           (* x (lp (cdr coeffs)))))))

;;; From John F. Hart, et.al., Computer Approximations, QA297.C64 1968
;;;           These are all good to at least 15 digits.
(define (bessj₀ x)
  (let ([ax (magnitude x)])
    (if (< ax 8.0)
        (let ([x² (* x x)])
          (/ (poly-by-coeffs->value
              x²
              +.1859623176218978035283999449e+18
              -.4414582939181598183458448718e+17
              +.2334489171877869744571586698e+16
              -.4776555944267358775465713161e+14
              +.4621722250317180263694186830e+12
              -.2271490439553603267422190396e+10
              +.5513584564770752154116759317e+7
              -.5292617130384557364907747176e+4)
             (poly-by-coeffs->value
              x²
              +.1859623176218977331294574009e+18
              +.2344750013658996756881142774e+16
              +.1501546244976975197238575580e+14
              +.6439867453513325627846468877e+11
              +.2042514835213435736159365899e+9
              +.4940307949181397241772754336e+6
              +.8847203675617550401186701293e+3
              +.1e+1)))
        (let* ([z (/ 8.0 ax)]
               [z² (* z z)]
               [ax-π/4 (- ax π/4)]
               [p₀ (/ (poly-by-coeffs->value
                       z²
                       +.8554822541506661710252074e+4
                       +.8894437532960619440762804e+4
                       +.2204501043965180428995069e+4
                       +.1286775857487141932988510e+3
                       +.9004793474802880316384000e+0)
                      (poly-by-coeffs->value
                       z²
                       +.8554822541506662842462151e+4
                       +.8903836141709595355210343e+4
                       +.2214048851914710419825683e+4
                       +.1308849004999238828351090e+3
                       +.1e+1))]
               [q₀ (/ (poly-by-coeffs->value
                       z²
                       -.37510534954957111594836e+2
                       -.46093826814625174976377e+2
                       -.13990976865960680088016e+2
                       -.10497327982345548331260e+1
                       -.93525953294031893049e-2)
                      (poly-by-coeffs->value
                       z²
                       +.2400674237117267479318819e+4
                       +.2971983745208491990065486e+4
                       +.921566975526530895082307e+3
                       +.74428389741411178824152e+2
                       +.1e1))])
          (* (sqrt (/ 2/π ax))
             (- (* (cos ax-π/4) p₀)
                (* z (sin ax-π/4) q₀)))))))


(define (bessj₁ x)
  (let ([ax (magnitude x)])
    (if (< ax 8.0)
        (let ([x² (* x x)])
          (/ (* x
                (poly-by-coeffs->value
                 x²
                 +.695364226329838502166085207e+8
                 -.8356785487348914291918495672e+7
                 +.3209027468853947029888682298e+6
                 -.58787877666568200462723094e+4
                 +.6121876997356943874446879769e+2
                 -.3983107983952332023421699105e+0
                 +.1705769264349617107854016566e-2
                 -.4910599276555129440130592573e-5
                 +.9382193365140744507653268479e-8
                 -.1107352224453730633782671362e-10
                 +.63194310317443161294700346e-14))
             (poly-by-coeffs->value
              x²
              +.139072845265967685120764336e+9
              +.6705346835482299302199750802e+6
              +.1284593453966301898121332163e+4
              +.1e+1)))
        (let* ([z (/ 8.0 ax)]
               [z² (* z z)]
               [ax-3π/4 (- ax 3π/4)]
               [p₁ (/ (poly-by-coeffs->value
                       z²
                       +.1290918471896188077350689e+5
                       +.1309042051103506486292571e+5
                       +.313275295635506951011069e+4
                       +.17431379748379024599685e+3
                       +.122850537643590432633e+1)
                      (poly-by-coeffs->value
                       z²
                       +.1290918471896187879332737e+5
                       +.1306678308784402036110575e+5
                       +.310928141677002883350924e+4
                       +.16904721775008609992033e+3
                       +.1e+1))]
               [q₁ (/ (poly-by-coeffs->value
                       z²
                       ;This line or the next is in error
                       ;+.14465282874995208675225e+3   
                       +.14465282874995208765225e+3
                       +.1744291689092425885102e+3
                       +.5173653281836591636536e+2
                       +.379944537969806734901e+1
                       +.36363466476034710809e-1)
                      (poly-by-coeffs->value
                       z²
                       +.308592701333231723110639e+4
                       +.373434010601630179517765e+4
                       +.11191098527047487025919e+4
                       +.8522392064341340397334e+2
                       +.1e+1))]
               [ans (* (sqrt (/ 2/π ax))
                       (- (* (cos ax-3π/4) p₁)
                          (* z (sin ax-3π/4) q₁)))])
          (if (< x 0.0) (- ans) ans)))))

(define (bessj n x)
  (define acc 40)
  (define bigno 1.0e10)
  (define bigni 1.0e-10)
  (cond
   [(fx= n 0) (bessj₀ x)]
   [(fx= n 1) (bessj₁ x)]
   [(= x 0.0) 0.0]
   [(< x 0.0) (if (even? n)
                  (bessj n (- x))
                  (- (bessj n (- x))))]
   [(fx< n 0) (if (even? n)
                  (bessj (- n) x)
                  (- (bessj (- n) x)))]
   [else
    (let* ([ax (magnitude x)]
           [2/ax (/ 2.0 ax)])
      (if (> ax n)
          (let lp ([j 1]
                   [bjm (bessj₀ ax)]
                   [bj (bessj₁ ax)])
            (if (fx= j n)
                (if (and (< x 0.0) (odd? n)) (- bj) bj)
                (lp (fx+ j 1)
                    bj
                    (- (* j 2/ax bj)
                       bjm))))
          (let ([m (round-to-even (+ n (sqrt (* acc n))))]
                [bj 1.0]
                [bjp 0.0]
                [ans 0.0]
                [sum 0.0])
            (let lp ([j m])
              (when (fx= j 0)
                (let ([ans (/ ans (- (* 2.0 sum) bj))])
                  (if (and (< x 0.0) (odd? n)) (- ans) ans)
                  (let ([bjm (- (* j 2/ax bj) bjp)])
                    (set! bjp bj)
                    (set! bj bjm)
                    (when (> (magnitude bj) bigno)
                      (set! bj  (* bj bigni))
                      (set! bjp (* bjp bigni))
                      (set! ans (* ans bigni))
                      (set! sum (* sum bigni)))
                    (when (odd? j)
                      (set! sum (+ sum bj)))
                    (when (fx= j n)
                      (set! ans bjp))
                    (lp (fx- j 1)))))))))]))

(define (bessj:0<x<<n n x)
  (/ (expt (/ x 2) n) (factorial n)))

(define (bessj:n<<x n x)
  (* (sqrt (/ 2 π x))
     (cos (- x (* π/2 n) π/4))))

(define (bessy₀ x)
  (define |x| (magnitude x))
  (if (< |x| 8.0)
      (let* ([x² (* x x)]
             [r₀ (poly-by-coeffs->value
                  x²
                  -.122848349966864707119444888e+8  ;p00
                  +.2950673961329634647867906439e+8 ;p01
                  -.2540763578168434015208700066e+7 ;p02
                  +.7768806299511773765193176993e+5 ;p03
                  -.1193299661108745921129349868e+4 ;p04
                  +.10753556131901778914962135e+2   ;p05
                  -.6186687126256085875960782886e-1 ;p06
                  +.2379830688791742855598085169e-3 ;p07
                  -.6227852796374134180786140767e-6 ;p08
                  +.1091804574277522610752537393e-8 ;p09
                  -.119120749069566983004259626e-11 ;p10
                  +.6321369945552678896098605e-15   ;p11
                  )]
             [s₀ (poly-by-coeffs->value
                  x²
                  +.1664514914558198835968659363e+9 ;q00
                  +.75939734950276133884153062e+6   ;q01
                  +.137072109013171838997378226e+4  ;q02
                  +1.0		                    ;q03
                  )])
        (+ (/ r₀ s₀)
           (* 2/π (bessj₀ x) (log x))))
      (let* ([z (/ 8.0 |x|)]
             [z² (* z z)]
             [|x|-π/4 (- |x| π/4)]
             [p₀ (/ (poly-by-coeffs->value
                     z²
                     +.8554822541506661710252074e+4
		     +.8894437532960619440762804e+4
		     +.2204501043965180428995069e+4
		     +.1286775857487141932988510e+3
		     +.9004793474802880316384000e+0)
                    (poly-by-coeffs->value
                     z²
                     +.8554822541506662842462151e+4
		     +.8903836141709595355210343e+4
		     +.2214048851914710419825683e+4
		     +.1308849004999238828351090e+3
		     +.1e+1))]
             [q₀ (/ (poly-by-coeffs->value
                     z²
                     -.37510534954957111594836e+2
		     -.46093826814625174976377e+2
		     -.13990976865960680088016e+2
		     -.10497327982345548331260e+1
		     -.93525953294031893049e-2)
                    (poly-by-coeffs->value
                     z²
                     +.2400674237117267479318819e+4
		     +.2971983745208491990065486e+4
		     +.921566975526530895082307e+3
		     +.74428389741411178824152e+2
		     +.1e1))])
        (* (sqrt (/ 2/π |x|))
           (+ (* (sin |x|-π/4) p₀)
              (* z (cos |x|-π/4) q₀))))))

(define (bessy₁ x)
  (define |x| (magnitude x))
  (if (< |x| 8.0)
      (let* ([x² (* x x)]
             [r₀ (poly-by-coeffs->value
                  x²
                  -.2493247725431151099221863985e+8  ;p00
                  +.678814979608784027013965029e+7   ;p01
                  -.3418758685257648961162234201e+6  ;p02
                  +.731876663732252704384675659e+4   ;p03
                  -.8477929772037826827977473917e+2  ;p04
                  +.5973109455969101918912869725e+0  ;p05
                  -.2723714918114737334647812804e-2  ;p06
                  +.8253358475754237969740284405e-5  ;p07
                  -.1645797675540583390670878295e-7  ;p08
                  +.2013974632712911344982964612e-10 ;p09
                  -.118503924369772697029706524e-13  ;p10
                  )]
             [s₀ (poly-by-coeffs->value
                  x²
                  +.1271694748306711445338693265e+9  ;q00
                  +.6291245810783959009675422035e+6  ;q01
                  +.1241151964683171602676430057e+4  ;q02
                  +1.0                               ;q03
                  )])
        (+ (/ (* x r₀) s₀)
           (* 2/π
              (- (* (bessj₁ x) (log x))
                 (/ 1.0 x)))))
      (let* ([z (/ 8.0 |x|)]
             [z² (* z z)]
             [|x|-3π/4 (- |x| 3π/4)]
             [p₁ (/ (poly-by-coeffs->value
                     z²
                     +.1290918471896188077350689e+5
		     +.1309042051103506486292571e+5
		     +.313275295635506951011069e+4
		     +.17431379748379024599685e+3
		     +.122850537643590432633e+1)
                    (poly-by-coeffs->value
                     z²
                     +.1290918471896187879332737e+5
		     +.1306678308784402036110575e+5
		     +.310928141677002883350924e+4
		     +.16904721775008609992033e+3
		     +.1e+1))]
             [q₁ (/ (poly-by-coeffs->value
                     z²
                     +.14465282874995208675225e+3
		     +.1744291689092425885102e+3
		     +.5173653281836591636536e+2
		     +.379944537969806734901e+1
		     +.36363466476034710809e-1)
                    (poly-by-coeffs->value
                     z²
                     +.308592701333231723110639e+4
		     +.373434010601630179517765e+4
		     +.11191098527047487025919e+4
		     +.8522392064341340397334e+2
		     +.1e+1))])
        (* (sqrt (/ 2/π |x|))
           (+ (* (sin |x|-3π/4) p₁)
              (* z (cos |x|-3π/4) q₁))))))

(define (bessy n x)
  (cond
   [(fx= n 0) (bessy₀ x)]
   [(fx= n 1) (bessy₁ x)]
   [(not (> x 0))
    (error "Argument out of range – Bessel Y" n x)]
   [else
    (let lp ([i 1]
             [yₙ (bessy₁ x)]
             [yₚ (bessy₀ x)])
      (if (fx= i n)
          yₙ
          (lp (fx+ i 1)
              (- (/ (* 2 i yₙ) x)
                 yₚ))))]))

;; Hankel functions H¹

(define (bessh n x)
  (+ (bessj n x)
     (* +i (bessy n x))))

(define (bessh₀ x) (bessh 0 x))

(define (bessh₁ x) (bessh 1 x))
